<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçå Nano Banana Remix - Photo Clothing Remix Tool</title>
    <!-- Libraries for PDF and ZIP export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 20px 60px rgba(0,0,0,0.3);
            --shadow-hover: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 40px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: inherit;
            background: white;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .model-select {
            font-weight: 600;
            cursor: pointer;
        }

        .model-select option {
            padding: 10px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .api-key-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-key-wrapper input {
            flex: 1;
        }

        .toggle-visibility {
            padding: 12px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .toggle-visibility:hover {
            background: var(--primary-dark);
        }

        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: #f8f9ff;
        }

        .file-upload-area.dragover {
            border-color: var(--primary);
            background: #f0f0ff;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .file-upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .file-preview {
            margin-top: 15px;
            display: none;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid #ddd;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .filename-display {
            margin-top: 10px;
            color: var(--success);
            font-weight: 600;
            font-size: 0.9em;
        }

        .image-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .image-upload-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
        }

        .image-upload-card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }

        .dimension-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .dimension-btn {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
            text-align: center;
        }

        .dimension-btn:hover {
            border-color: var(--primary);
            background: #f0f0ff;
            transform: translateY(-2px);
        }

        .dimension-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .rate-limit-card {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid var(--warning);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .rate-limit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rate-limit-counter {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .rate-limit-counter.warning {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 70%, var(--danger) 100%);
            transition: width 0.5s ease;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .rate-limit-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .rate-limit-input {
            width: 100px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
            margin-top: 20px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            animation: slideDown 0.3s ease;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .alert a {
            color: inherit;
            text-decoration: underline;
            font-weight: 600;
        }

        .alert.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger);
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid var(--info);
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success);
        }

        .output-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #eee;
            display: none;
        }

        .output-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .output-image {
            text-align: center;
        }

        .output-image img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .output-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid var(--primary);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }

        .info-box strong {
            display: block;
            margin-bottom: 10px;
            color: #333;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin: 8px 0;
            color: #555;
        }

        .info-box a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .reset-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }

        .prompt-auto {
            background: #f0f0ff;
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
        }

        .history-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #eee;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .history-item {
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 10px;
            position: relative;
            transition: all 0.3s;
        }

        .history-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .history-item.selected {
            border-color: var(--primary);
            background: #f0f0ff;
        }

        .history-item-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
        }

        .history-item img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .history-item-prompt {
            font-size: 0.85em;
            color: #666;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .history-item-date {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        .select-all-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .image-upload-grid {
                grid-template-columns: 1fr;
            }

            .dimension-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .rate-limit-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .rate-limit-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçå Nano Banana Remix</h1>
            <p class="subtitle">Photo Clothing Remix Tool - Superimpose Clothing onto Subject</p>
        </header>

        <!-- Rate Limit Section -->
        <div class="rate-limit-card">
            <div class="rate-limit-header">
                <div>
                    <strong>üìä Daily Rate Limit</strong>
                </div>
                <div class="rate-limit-counter" id="rateLimitCounter">0 / 100</div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="rate-limit-controls">
                <label for="dailyLimit">Daily Limit:</label>
                <input type="number" id="dailyLimit" class="rate-limit-input" value="100" min="1" max="10000" />
                <button class="btn btn-danger" id="resetLimitBtn">Reset Counter</button>
            </div>
            <div class="reset-info" id="resetInfo">Resets at midnight (local time)</div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <strong>üí° How to Use:</strong>
            <ul>
                <li>Get your API key from <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a></li>
                <li><strong>Image 1 (Subject):</strong> Upload a photo of the person/character you want to dress</li>
                <li><strong>Image 2 (Clothing):</strong> Upload a photo of the clothing item you want to add</li>
                <li>The prompt will automatically instruct the AI to superimpose the clothing onto the subject</li>
                <li>You can optionally add additional instructions in the prompt field</li>
            </ul>
        </div>

        <!-- API Key Section -->
        <div class="section">
            <div class="section-title">üîë API Configuration</div>
            <div class="form-group">
                <label for="apiKey">Google AI API Key</label>
                <div class="api-key-wrapper">
                    <input type="password" id="apiKey" placeholder="Enter your Google AI API key" autocomplete="off" />
                    <button type="button" class="toggle-visibility" id="toggleApiKey">üëÅÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- Image Upload Section - Two Images -->
        <div class="section">
            <div class="section-title">üì∑ Upload Images</div>
            <div class="image-upload-grid">
                <!-- Subject Image -->
                <div class="image-upload-card">
                    <h3>üë§ Image 1: Subject (Base/Character)</h3>
                    <div class="file-upload-area" id="subjectUploadArea">
                        <div class="file-upload-icon">üì§</div>
                        <p><strong>Click to upload</strong> or drag and drop</p>
                        <p style="color: #666; font-size: 0.9em; margin-top: 5px;">JPG, PNG, WebP (Max 10MB)</p>
                        <input type="file" id="subjectImageInput" accept="image/*" />
                    </div>
                    <div class="filename-display" id="subjectFilenameDisplay"></div>
                    <div class="file-preview" id="subjectPreview">
                        <img id="subjectPreviewImage" alt="Subject Preview" />
                    </div>
                </div>

                <!-- Clothing Image -->
                <div class="image-upload-card">
                    <h3>üëï Image 2: Clothing Item</h3>
                    <div class="file-upload-area" id="clothingUploadArea">
                        <div class="file-upload-icon">üì§</div>
                        <p><strong>Click to upload</strong> or drag and drop</p>
                        <p style="color: #666; font-size: 0.9em; margin-top: 5px;">JPG, PNG, WebP (Max 10MB)</p>
                        <input type="file" id="clothingImageInput" accept="image/*" />
                    </div>
                    <div class="filename-display" id="clothingFilenameDisplay"></div>
                    <div class="file-preview" id="clothingPreview">
                        <img id="clothingPreviewImage" alt="Clothing Preview" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Section -->
        <div class="section">
            <div class="section-title">‚úçÔ∏è Additional Instructions (Optional)</div>
            <div class="form-group">
                <label for="prompt">Add any additional styling or modification instructions</label>
                <textarea id="prompt" placeholder="Example: Make the clothing fit naturally, adjust lighting to match, keep the subject's pose"></textarea>
                <div class="prompt-auto" id="autoPromptDisplay" style="display: none;">
                    <strong>Auto-generated prompt:</strong> <span id="autoPromptText"></span>
                </div>
            </div>
        </div>

        <!-- Model Selection Section -->
        <div class="section">
            <div class="section-title">ü§ñ AI Model Selection</div>
            <div class="form-group">
                <label for="modelSelect">Choose Gemini Model</label>
                <select id="modelSelect" class="model-select">
                    <option value="gemini-2.5-flash-image" selected>Gemini 2.5 Flash Image (Recommended - Stable)</option>
                    <option value="gemini-2.5-flash-preview-image">Gemini 2.5 Flash Preview Image (Preview)</option>
                    <option value="gemini-2.0-flash-exp-image-generation">Gemini 2.0 Flash Exp Image (Experimental)</option>
                    <option value="custom">Custom Model (Enter below)</option>
                </select>
                <div id="customModelContainer" style="display: none; margin-top: 10px;">
                    <label for="customModelInput">Custom Model Name:</label>
                    <input type="text" id="customModelInput" placeholder="e.g., gemini-3.0-pro-image" style="margin-top: 5px;" />
                </div>
                <p style="margin-top: 8px; color: #666; font-size: 0.9em;">
                    ‚ö†Ô∏è <strong>Note:</strong> Gemini 3.0 image generation models are not yet available via the API. The models listed above are the currently available options. Check <a href="https://ai.google.dev/gemini-api/docs/models" target="_blank" rel="noopener noreferrer">official documentation</a> for updates on new model releases.
                </p>
            </div>
        </div>

        <!-- Dimensions Section -->
        <div class="section">
            <div class="section-title">üìê Output Dimensions</div>
            <div class="dimension-grid">
                <button class="dimension-btn active" data-width="1024" data-height="1024">1024√ó1024<br><small>Square</small></button>
                <button class="dimension-btn" data-width="1024" data-height="768">1024√ó768<br><small>Landscape</small></button>
                <button class="dimension-btn" data-width="768" data-height="1024">768√ó1024<br><small>Portrait</small></button>
                <button class="dimension-btn" data-width="1536" data-height="1024">1536√ó1024<br><small>Wide</small></button>
                <button class="dimension-btn" data-width="1024" data-height="1536">1024√ó1536<br><small>Tall</small></button>
                <button class="dimension-btn" data-width="2048" data-height="2048">2048√ó2048<br><small>Large Square</small></button>
            </div>
        </div>

        <!-- Generate Button -->
        <button class="btn btn-primary" id="generateBtn">üöÄ Remix Images</button>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Remixing your images with Nano Banana...</p>
            <p style="color: #666; font-size: 0.9em; margin-top: 10px;">This may take 10-30 seconds</p>
        </div>

        <!-- Alert Messages -->
        <div class="alert alert-error" id="errorAlert"></div>
        <div class="alert alert-info" id="infoAlert"></div>
        <div class="alert alert-success" id="successAlert"></div>

        <!-- Output Section -->
        <div class="output-section" id="outputSection">
            <h2 style="margin-bottom: 20px; text-align: center;">‚ú® Remixed Image</h2>
            <div class="output-image">
                <img id="outputImage" alt="Generated" />
                <div class="output-actions">
                    <a href="#" class="btn btn-success" id="downloadBtn" download="nano-banana-remix.png">‚¨áÔ∏è Download</a>
                    <button class="btn btn-primary" id="regenerateBtn" style="width: auto;">üîÑ Remix Again</button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="history-section" id="historySection">
            <div class="history-header">
                <h2>üìö Generation History</h2>
                <div class="history-controls">
                    <div class="select-all-controls">
                        <button class="btn" id="selectAllBtn" style="background: #6c757d; color: white;">Select All</button>
                        <button class="btn" id="deselectAllBtn" style="background: #6c757d; color: white;">Deselect All</button>
                    </div>
                    <button class="btn btn-success" id="exportPdfBtn">üìÑ Export PDF</button>
                    <button class="btn btn-primary" id="exportZipBtn">üì¶ Export ZIP</button>
                    <button class="btn btn-danger" id="clearHistoryBtn">üóëÔ∏è Clear History</button>
                </div>
            </div>
            <div class="history-grid" id="historyGrid">
                <!-- History items will be added here dynamically -->
            </div>
            <p id="noHistoryMessage" style="text-align: center; color: #999; padding: 20px; display: none;">
                No generation history yet. Generate some images to see them here!
            </p>
        </div>
    </div>

    <script>
        // DOM Elements
        const elements = {
            apiKey: document.getElementById('apiKey'),
            toggleApiKey: document.getElementById('toggleApiKey'),
            prompt: document.getElementById('prompt'),
            subjectImageInput: document.getElementById('subjectImageInput'),
            clothingImageInput: document.getElementById('clothingImageInput'),
            subjectUploadArea: document.getElementById('subjectUploadArea'),
            clothingUploadArea: document.getElementById('clothingUploadArea'),
            subjectPreview: document.getElementById('subjectPreview'),
            clothingPreview: document.getElementById('clothingPreview'),
            subjectPreviewImage: document.getElementById('subjectPreviewImage'),
            clothingPreviewImage: document.getElementById('clothingPreviewImage'),
            subjectFilenameDisplay: document.getElementById('subjectFilenameDisplay'),
            clothingFilenameDisplay: document.getElementById('clothingFilenameDisplay'),
            dimensionBtns: document.querySelectorAll('.dimension-btn'),
            generateBtn: document.getElementById('generateBtn'),
            regenerateBtn: document.getElementById('regenerateBtn'),
            loading: document.getElementById('loading'),
            errorAlert: document.getElementById('errorAlert'),
            infoAlert: document.getElementById('infoAlert'),
            successAlert: document.getElementById('successAlert'),
            outputSection: document.getElementById('outputSection'),
            outputImage: document.getElementById('outputImage'),
            downloadBtn: document.getElementById('downloadBtn'),
            rateLimitCounter: document.getElementById('rateLimitCounter'),
            progressBar: document.getElementById('progressBar'),
            dailyLimitInput: document.getElementById('dailyLimit'),
            resetLimitBtn: document.getElementById('resetLimitBtn'),
            resetInfo: document.getElementById('resetInfo'),
            modelSelect: document.getElementById('modelSelect'),
            customModelContainer: document.getElementById('customModelContainer'),
            customModelInput: document.getElementById('customModelInput'),
            autoPromptDisplay: document.getElementById('autoPromptDisplay'),
            autoPromptText: document.getElementById('autoPromptText')
        };

        // State
        let state = {
            selectedDimensions: { width: 1024, height: 1024 },
            subjectImageBase64: null,
            subjectImageMimeType: null,
            clothingImageBase64: null,
            clothingImageMimeType: null,
            apiKeyVisible: false,
            selectedModel: 'gemini-2.5-flash-image',
            history: []
        };

        // Load history from localStorage
        function loadHistory() {
            const stored = localStorage.getItem('nanoBananaRemixHistory');
            if (stored) {
                try {
                    state.history = JSON.parse(stored);
                } catch (e) {
                    state.history = [];
                }
            }
            renderHistory();
        }

        // Save history to localStorage
        function saveHistory() {
            localStorage.setItem('nanoBananaRemixHistory', JSON.stringify(state.history));
        }

        // Add item to history
        function addToHistory(imageBase64, prompt, dimensions) {
            const historyItem = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                imageBase64: imageBase64,
                prompt: prompt,
                dimensions: dimensions,
                timestamp: new Date().toISOString(),
                selected: false
            };
            state.history.unshift(historyItem); // Add to beginning
            saveHistory();
            renderHistory();
        }

        // Render history grid
        function renderHistory() {
            if (state.history.length === 0) {
                elements.historyGrid.innerHTML = '';
                elements.noHistoryMessage.style.display = 'block';
                return;
            }

            elements.noHistoryMessage.style.display = 'none';
            elements.historyGrid.innerHTML = state.history.map(item => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const promptPreview = item.prompt.length > 100 
                    ? item.prompt.substring(0, 100) + '...' 
                    : item.prompt;
                
                return `
                    <div class="history-item ${item.selected ? 'selected' : ''}" data-id="${item.id}">
                        <input type="checkbox" class="history-item-checkbox" ${item.selected ? 'checked' : ''} 
                               onchange="toggleHistoryItem('${item.id}')" />
                        <img src="data:image/png;base64,${item.imageBase64}" alt="Generated" />
                        <div class="history-item-prompt" title="${item.prompt}">${promptPreview}</div>
                        <div class="history-item-date">${dateStr}</div>
                    </div>
                `;
            }).join('');
        }

        // Toggle history item selection
        window.toggleHistoryItem = function(id) {
            const item = state.history.find(h => h.id === id);
            if (item) {
                item.selected = !item.selected;
                saveHistory();
                renderHistory();
            }
        };

        // Select all history items
        elements.selectAllBtn.addEventListener('click', () => {
            state.history.forEach(item => item.selected = true);
            saveHistory();
            renderHistory();
        });

        // Deselect all history items
        elements.deselectAllBtn.addEventListener('click', () => {
            state.history.forEach(item => item.selected = false);
            saveHistory();
            renderHistory();
        });

        // Clear history
        elements.clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                state.history = [];
                saveHistory();
                renderHistory();
                alertManager.show('History cleared successfully!', 'success');
            }
        });

        // Export to PDF
        elements.exportPdfBtn.addEventListener('click', async () => {
            const selected = state.history.filter(item => item.selected);
            
            if (selected.length === 0) {
                alertManager.show('Please select at least one item to export', 'error');
                return;
            }

            elements.exportPdfBtn.disabled = true;
            elements.exportPdfBtn.textContent = '‚è≥ Generating PDF...';

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                const imageWidth = pageWidth - (margin * 2);
                let yPos = margin;

                for (let i = 0; i < selected.length; i++) {
                    const item = selected[i];
                    
                    // Add new page if not first item
                    if (i > 0) {
                        pdf.addPage();
                        yPos = margin;
                    }

                    // Convert base64 to image
                    const img = new Image();
                    img.src = `data:image/png;base64,${item.imageBase64}`;
                    
                    await new Promise((resolve, reject) => {
                        img.onload = () => {
                            try {
                                // Calculate image height to fit width
                                const aspectRatio = img.height / img.width;
                                const imageHeight = imageWidth * aspectRatio;
                                
                                // Check if image fits on page
                                if (yPos + imageHeight > pageHeight - margin - 40) {
                                    pdf.addPage();
                                    yPos = margin;
                                }
                                
                                // Add image
                                pdf.addImage(img, 'PNG', margin, yPos, imageWidth, imageHeight);
                                yPos += imageHeight + 10;
                                
                                // Add prompt text
                                const promptLines = pdf.splitTextToSize(item.prompt, imageWidth);
                                const promptHeight = promptLines.length * 5;
                                
                                // Check if prompt fits on page
                                if (yPos + promptHeight > pageHeight - margin) {
                                    pdf.addPage();
                                    yPos = margin;
                                }
                                
                                pdf.setFontSize(10);
                                pdf.text('Prompt:', margin, yPos);
                                yPos += 5;
                                pdf.setFontSize(8);
                                pdf.text(promptLines, margin, yPos);
                                yPos += promptHeight + 10;
                                
                                resolve();
                            } catch (err) {
                                reject(err);
                            }
                        };
                        img.onerror = () => {
                            reject(new Error(`Failed to load image ${i + 1}`));
                        };
                    });
                }

                pdf.save(`nano-banana-remix-${Date.now()}.pdf`);
                alertManager.show(`PDF exported successfully with ${selected.length} item(s)!`, 'success');
            } catch (error) {
                console.error('PDF export error:', error);
                alertManager.show(`Error exporting PDF: ${error.message}`, 'error');
            } finally {
                elements.exportPdfBtn.disabled = false;
                elements.exportPdfBtn.textContent = 'üìÑ Export PDF';
            }
        });

        // Export to ZIP
        elements.exportZipBtn.addEventListener('click', async () => {
            const selected = state.history.filter(item => item.selected);
            
            if (selected.length === 0) {
                alertManager.show('Please select at least one item to export', 'error');
                return;
            }

            elements.exportZipBtn.disabled = true;
            elements.exportZipBtn.textContent = '‚è≥ Creating ZIP...';

            try {
                const zip = new JSZip();
                const promptsText = [];

                for (let i = 0; i < selected.length; i++) {
                    const item = selected[i];
                    const date = new Date(item.timestamp);
                    const filename = `image-${i + 1}-${date.getTime()}.png`;
                    
                    // Add image to zip
                    const imageData = atob(item.imageBase64);
                    const imageBytes = new Uint8Array(imageData.length);
                    for (let j = 0; j < imageData.length; j++) {
                        imageBytes[j] = imageData.charCodeAt(j);
                    }
                    zip.file(filename, imageBytes);
                    
                    // Add prompt to text array
                    promptsText.push(`--- Image ${i + 1}: ${filename} ---\n${item.prompt}\n`);
                }

                // Add prompts text file
                zip.file('prompts.txt', promptsText.join('\n\n'));

                // Generate and download ZIP
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nano-banana-remix-${Date.now()}.zip`;
                a.click();
                URL.revokeObjectURL(url);

                alertManager.show(`ZIP exported successfully with ${selected.length} item(s)!`, 'success');
            } catch (error) {
                console.error('ZIP export error:', error);
                alertManager.show(`Error exporting ZIP: ${error.message}`, 'error');
            } finally {
                elements.exportZipBtn.disabled = false;
                elements.exportZipBtn.textContent = 'üì¶ Export ZIP';
            }
        });

        // Initialize history on load
        loadHistory();

        // Rate Limit Manager (same as original)
        class RateLimitManager {
            constructor() {
                this.storageKey = 'nanoBananaRemixRateLimit';
                this.limitKey = 'nanoBananaRemixDailyLimit';
                this.init();
            }

            init() {
                const data = this.getData();
                const today = this.getTodayDate();

                if (data.date !== today) {
                    this.reset();
                }

                this.scheduleNextReset();
                this.updateUI();
            }

            getTodayDate() {
                return new Date().toDateString();
            }

            getData() {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    return JSON.parse(stored);
                }
                return { count: 0, date: this.getTodayDate() };
            }

            getLimit() {
                const stored = localStorage.getItem(this.limitKey);
                return stored ? parseInt(stored) : 100;
            }

            setLimit(limit) {
                localStorage.setItem(this.limitKey, limit.toString());
                this.updateUI();
            }

            saveData(data) {
                localStorage.setItem(this.storageKey, JSON.stringify(data));
            }

            increment() {
                const data = this.getData();
                data.count += 1;
                this.saveData(data);
                this.updateUI();
            }

            reset() {
                const data = { count: 0, date: this.getTodayDate() };
                this.saveData(data);
                this.updateUI();
            }

            canGenerate() {
                const data = this.getData();
                const limit = this.getLimit();
                return data.count < limit;
            }

            getRemaining() {
                const data = this.getData();
                const limit = this.getLimit();
                return Math.max(0, limit - data.count);
            }

            updateUI() {
                const data = this.getData();
                const limit = this.getLimit();
                const percentage = (data.count / limit) * 100;

                elements.rateLimitCounter.textContent = `${data.count} / ${limit}`;
                elements.progressBar.style.width = `${Math.min(percentage, 100)}%`;
                elements.progressBar.textContent = percentage > 5 ? `${Math.round(percentage)}%` : '';

                if (percentage >= 80) {
                    elements.rateLimitCounter.classList.add('warning');
                } else {
                    elements.rateLimitCounter.classList.remove('warning');
                }

                this.updateResetInfo();
            }

            updateResetInfo() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);

                const msUntilReset = tomorrow - now;
                const hoursUntilReset = Math.floor(msUntilReset / (1000 * 60 * 60));
                const minutesUntilReset = Math.floor((msUntilReset / (1000 * 60)) % 60);

                elements.resetInfo.textContent = `Resets in ${hoursUntilReset}h ${minutesUntilReset}m`;
            }

            scheduleNextReset() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);

                const msUntilMidnight = tomorrow - now;

                setTimeout(() => {
                    this.reset();
                    this.scheduleNextReset();
                }, msUntilMidnight);

                setInterval(() => this.updateResetInfo(), 60000);
            }
        }

        // Alert Manager (same as original)
        class AlertManager {
            show(message, type = 'error', duration = 5000) {
                elements.errorAlert.classList.remove('active');
                elements.infoAlert.classList.remove('active');
                elements.successAlert.classList.remove('active');

                let alertElement;
                switch(type) {
                    case 'error':
                        alertElement = elements.errorAlert;
                        break;
                    case 'info':
                        alertElement = elements.infoAlert;
                        break;
                    case 'success':
                        alertElement = elements.successAlert;
                        break;
                }

                if (message.includes('\n')) {
                    alertElement.innerHTML = message.split('\n').map(line => {
                        if (line.match(/https?:\/\/[^\s]+/)) {
                            return line.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: underline;">$1</a>');
                        }
                        return line;
                    }).join('<br>');
                } else {
                    if (message.match(/https?:\/\/[^\s]+/)) {
                        alertElement.innerHTML = message.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: underline;">$1</a>');
                    } else {
                        alertElement.textContent = message;
                    }
                }
                
                alertElement.classList.add('active');

                if (type === 'error' && message.includes('Quota')) {
                    duration = 15000;
                }

                if (duration > 0) {
                    setTimeout(() => {
                        alertElement.classList.remove('active');
                    }, duration);
                }
            }

            hide() {
                elements.errorAlert.classList.remove('active');
                elements.infoAlert.classList.remove('active');
                elements.successAlert.classList.remove('active');
            }
        }

        // Initialize managers
        const rateLimitManager = new RateLimitManager();
        const alertManager = new AlertManager();

        // API Key Management
        const savedApiKey = localStorage.getItem('nanoBananaRemixApiKey');
        if (savedApiKey) {
            elements.apiKey.value = savedApiKey;
        }

        elements.apiKey.addEventListener('input', () => {
            localStorage.setItem('nanoBananaRemixApiKey', elements.apiKey.value);
        });

        elements.toggleApiKey.addEventListener('click', () => {
            state.apiKeyVisible = !state.apiKeyVisible;
            elements.apiKey.type = state.apiKeyVisible ? 'text' : 'password';
            elements.toggleApiKey.textContent = state.apiKeyVisible ? 'üôà' : 'üëÅÔ∏è';
        });

        // Model Selection
        const savedModel = localStorage.getItem('nanoBananaRemixSelectedModel');
        if (savedModel) {
            elements.modelSelect.value = savedModel;
            state.selectedModel = savedModel;
        } else {
            state.selectedModel = elements.modelSelect.value;
        }

        elements.modelSelect.addEventListener('change', () => {
            const selectedValue = elements.modelSelect.value;
            
            if (selectedValue === 'custom') {
                elements.customModelContainer.style.display = 'block';
                const savedCustomModel = localStorage.getItem('nanoBananaRemixCustomModel');
                if (savedCustomModel) {
                    elements.customModelInput.value = savedCustomModel;
                    state.selectedModel = savedCustomModel;
                } else {
                    state.selectedModel = '';
                }
            } else {
                elements.customModelContainer.style.display = 'none';
                state.selectedModel = selectedValue;
                localStorage.setItem('nanoBananaRemixSelectedModel', state.selectedModel);
            }
        });

        elements.customModelInput.addEventListener('input', () => {
            const customModel = elements.customModelInput.value.trim();
            if (customModel) {
                state.selectedModel = customModel;
                localStorage.setItem('nanoBananaRemixCustomModel', customModel);
            }
        });

        if (elements.modelSelect.value === 'custom') {
            elements.customModelContainer.style.display = 'block';
            const savedCustomModel = localStorage.getItem('nanoBananaRemixCustomModel');
            if (savedCustomModel) {
                elements.customModelInput.value = savedCustomModel;
                state.selectedModel = savedCustomModel;
            }
        }

        // Daily Limit Management
        elements.dailyLimitInput.value = rateLimitManager.getLimit();

        elements.dailyLimitInput.addEventListener('change', () => {
            const newLimit = parseInt(elements.dailyLimitInput.value);
            if (newLimit > 0 && newLimit <= 10000) {
                rateLimitManager.setLimit(newLimit);
            }
        });

        elements.resetLimitBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset the daily counter?')) {
                rateLimitManager.reset();
                alertManager.show('Daily counter reset successfully!', 'success');
            }
        });

        // Dimension Selection
        elements.dimensionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                elements.dimensionBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.selectedDimensions = {
                    width: parseInt(btn.dataset.width),
                    height: parseInt(btn.dataset.height)
                };
            });
        });

        // File Upload Handlers
        function setupFileUpload(inputElement, uploadArea, previewElement, previewImage, filenameDisplay, isSubject) {
            uploadArea.addEventListener('click', () => {
                inputElement.click();
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleFileUpload(files[0], previewElement, previewImage, filenameDisplay, isSubject);
                }
            });

            inputElement.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file, previewElement, previewImage, filenameDisplay, isSubject);
                }
            });
        }

        function handleFileUpload(file, previewElement, previewImage, filenameDisplay, isSubject) {
            if (file.size > 10 * 1024 * 1024) {
                alertManager.show('File size must be less than 10MB', 'error');
                return;
            }

            filenameDisplay.textContent = `‚úì ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                previewImage.src = dataUrl;
                previewElement.style.display = 'block';
                
                const matches = dataUrl.match(/^data:(.+);base64,(.+)$/);
                if (matches) {
                    if (isSubject) {
                        state.subjectImageMimeType = matches[1];
                        state.subjectImageBase64 = matches[2];
                    } else {
                        state.clothingImageMimeType = matches[1];
                        state.clothingImageBase64 = matches[2];
                    }
                }
                updateAutoPrompt();
            };
            reader.readAsDataURL(file);
        }

        // Setup both file uploads
        setupFileUpload(
            elements.subjectImageInput,
            elements.subjectUploadArea,
            elements.subjectPreview,
            elements.subjectPreviewImage,
            elements.subjectFilenameDisplay,
            true
        );

        setupFileUpload(
            elements.clothingImageInput,
            elements.clothingUploadArea,
            elements.clothingPreview,
            elements.clothingPreviewImage,
            elements.clothingFilenameDisplay,
            false
        );

        // Auto-generate prompt
        function updateAutoPrompt() {
            if (state.subjectImageBase64 && state.clothingImageBase64) {
                const basePrompt = "Take the first image (the subject/person) and superimpose, add, or place the clothing item from the second image onto the subject. Make sure the clothing fits naturally, matches the subject's pose and body proportions, and blends seamlessly with the original image. Maintain realistic lighting, shadows, and textures. The final result should look like the subject is actually wearing the clothing item.";
                const additionalPrompt = elements.prompt.value.trim();
                
                const fullPrompt = additionalPrompt 
                    ? `${basePrompt} Additional instructions: ${additionalPrompt}`
                    : basePrompt;
                
                elements.autoPromptText.textContent = fullPrompt;
                elements.autoPromptDisplay.style.display = 'block';
            } else {
                elements.autoPromptDisplay.style.display = 'none';
            }
        }

        elements.prompt.addEventListener('input', updateAutoPrompt);

        // Image Generation
        elements.generateBtn.addEventListener('click', handleGenerate);
        elements.regenerateBtn.addEventListener('click', handleGenerate);

        async function handleGenerate() {
            const apiKey = elements.apiKey.value.trim();

            // Validation
            if (!apiKey) {
                alertManager.show('Please enter your Google AI API key', 'error');
                elements.apiKey.focus();
                return;
            }

            if (!state.subjectImageBase64) {
                alertManager.show('Please upload Image 1 (Subject/Base image)', 'error');
                return;
            }

            if (!state.clothingImageBase64) {
                alertManager.show('Please upload Image 2 (Clothing item)', 'error');
                return;
            }

            // Check rate limit
            if (!rateLimitManager.canGenerate()) {
                alertManager.show(`Daily limit reached! You've used all ${rateLimitManager.getLimit()} generations today.`, 'error');
                return;
            }

            // Hide previous results
            elements.outputSection.classList.remove('active');
            alertManager.hide();

            // Show loading
            elements.generateBtn.disabled = true;
            elements.regenerateBtn.disabled = true;
            elements.loading.classList.add('active');

            try {
                // Generate the full prompt
                const basePrompt = "Take the first image (the subject/person) and superimpose, add, or place the clothing item from the second image onto the subject. Make sure the clothing fits naturally, matches the subject's pose and body proportions, and blends seamlessly with the original image. Maintain realistic lighting, shadows, and textures. The final result should look like the subject is actually wearing the clothing item.";
                const additionalPrompt = elements.prompt.value.trim();
                const fullPrompt = additionalPrompt 
                    ? `${basePrompt} Additional instructions: ${additionalPrompt}`
                    : basePrompt;

                const response = await generateImage(
                    apiKey,
                    fullPrompt,
                    state.subjectImageBase64,
                    state.subjectImageMimeType,
                    state.clothingImageBase64,
                    state.clothingImageMimeType,
                    state.selectedDimensions
                );

                if (response.error) {
                    throw new Error(response.error);
                }

                // Increment rate limit
                rateLimitManager.increment();

                // Display image
                const imageData = response.imageBase64;
                elements.outputImage.src = `data:image/png;base64,${imageData}`;
                elements.downloadBtn.href = `data:image/png;base64,${imageData}`;
                elements.outputSection.classList.add('active');

                // Add to history
                const basePrompt = "Take the first image (the subject/person) and superimpose, add, or place the clothing item from the second image onto the subject. Make sure the clothing fits naturally, matches the subject's pose and body proportions, and blends seamlessly with the original image. Maintain realistic lighting, shadows, and textures. The final result should look like the subject is actually wearing the clothing item.";
                const additionalPrompt = elements.prompt.value.trim();
                const fullPrompt = additionalPrompt 
                    ? `${basePrompt} Additional instructions: ${additionalPrompt}`
                    : basePrompt;
                
                addToHistory(imageData, fullPrompt, state.selectedDimensions);

                // Scroll to output
                elements.outputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Show success message
                const remaining = rateLimitManager.getRemaining();
                if (remaining <= 10) {
                    alertManager.show(`Success! ${remaining} generations remaining today.`, 'info');
                } else {
                    alertManager.show('Image remixed successfully!', 'success', 3000);
                }

            } catch (error) {
                console.error('Generation error:', error);
                
                let errorMessage = error.message;
                
                if (error.retryAfter) {
                    const retrySeconds = Math.ceil(error.retryAfter);
                    errorMessage += `\n\n‚è∞ Auto-retry available in ${retrySeconds} seconds`;
                }
                
                alertManager.show(errorMessage, 'error');
            } finally {
                elements.generateBtn.disabled = false;
                elements.regenerateBtn.disabled = false;
                elements.loading.classList.remove('active');
            }
        }

        async function generateImage(apiKey, prompt, subjectImageBase64, subjectImageMimeType, clothingImageBase64, clothingImageMimeType, dimensions) {
            let modelName = state.selectedModel || 'gemini-2.5-flash-image';
            
            if (elements.modelSelect.value === 'custom' && (!modelName || modelName.trim() === '')) {
                throw new Error('Please enter a custom model name or select a different model from the dropdown.');
            }
            
            if (!modelName || modelName === 'custom') {
                modelName = 'gemini-2.5-flash-image';
            }
            
            console.log(`Using selected model: ${modelName}`);
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent`;
            return await tryGenerateWithModel(url, apiKey, prompt, subjectImageBase64, subjectImageMimeType, clothingImageBase64, clothingImageMimeType, dimensions);
        }

        async function tryGenerateWithModel(url, apiKey, prompt, subjectImageBase64, subjectImageMimeType, clothingImageBase64, clothingImageMimeType, dimensions) {
            
            const contents = [{
                role: "user",
                parts: [{ text: prompt }]
            }];

            // Add subject image (first image)
            if (subjectImageBase64) {
                contents[0].parts.push({
                    inline_data: {
                        mime_type: subjectImageMimeType || "image/png",
                        data: subjectImageBase64
                    }
                });
            }

            // Add clothing image (second image)
            if (clothingImageBase64) {
                contents[0].parts.push({
                    inline_data: {
                        mime_type: clothingImageMimeType || "image/png",
                        data: clothingImageBase64
                    }
                });
            }

            // Add dimension instructions
            const dimensionPrompt = `\n\nOutput dimensions: ${dimensions.width}x${dimensions.height}`;
            contents[0].parts[0].text += dimensionPrompt;

            const requestBody = {
                contents: contents,
                generationConfig: {
                    temperature: 1,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                }
            };

            const response = await fetch(`${url}?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                let errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                let retryAfter = null;
                
                if (response.status === 429) {
                    retryAfter = errorData.error?.details?.[0]?.retryDelay || 
                                errorData.error?.retryDelay ||
                                (errorMessage.match(/Please retry in ([\d.]+)s/) ? 
                                 parseFloat(errorMessage.match(/Please retry in ([\d.]+)s/)[1]) : null);
                    
                    if (errorMessage.includes('quota') || errorMessage.includes('Quota exceeded')) {
                        errorMessage = `‚ùå Quota Exceeded\n\n` +
                            `You've reached your API quota limit. This usually means:\n\n` +
                            `‚Ä¢ Free tier quota has been used up\n` +
                            `‚Ä¢ Billing may need to be enabled in Google Cloud Console\n` +
                            `‚Ä¢ You may need to upgrade your plan\n\n` +
                            `Check your usage: https://ai.dev/usage?tab=rate-limit\n` +
                            `Rate limit info: https://ai.google.dev/gemini-api/docs/rate-limits\n\n` +
                            (retryAfter ? `‚è∞ Retry available in ${Math.ceil(retryAfter)} seconds` : '');
                    } else {
                        errorMessage = `‚è±Ô∏è Rate Limit Reached\n\n` +
                            `Too many requests. ` +
                            (retryAfter ? `Please wait ${Math.ceil(retryAfter)} seconds and try again.` : 
                             'Please wait a moment and try again.');
                    }
                } else if (response.status === 404) {
                    errorMessage = `Model not found (404). This model may not be available with your API key or may have been deprecated.`;
                }
                
                const error = new Error(errorMessage);
                error.status = response.status;
                error.retryAfter = retryAfter;
                error.isQuotaError = response.status === 429 && errorMessage.includes('quota');
                throw error;
            }

            const data = await response.json();

            console.log('API Response:', JSON.stringify(data, null, 2));

            // Check for finishReason
            if (data.candidates && data.candidates.length > 0) {
                const candidate = data.candidates[0];
                
                if (candidate.finishReason) {
                    if (candidate.finishReason === 'IMAGE_SAFETY') {
                        const safetyMessage = candidate.finishMessage || 
                            'The image was filtered out because it violated Google\'s Generative AI Prohibited Use policy.';
                        throw new Error(`üõ°Ô∏è Content Safety Filter\n\n${safetyMessage}\n\nTry rephrasing your prompt to avoid prohibited content.`);
                    } else if (candidate.finishReason === 'IMAGE_OTHER') {
                        const otherMessage = candidate.finishMessage || 
                            'The model could not generate the image based on the prompt provided.';
                        throw new Error(`‚ö†Ô∏è Image Generation Failed\n\n${otherMessage}\n\nTry rephrasing your prompt or using different parameters.`);
                    } else if (candidate.finishReason === 'SAFETY' || candidate.finishReason === 'RECITATION') {
                        const reasonMessage = candidate.finishMessage || 
                            `Generation stopped due to: ${candidate.finishReason}`;
                        throw new Error(`‚ö†Ô∏è Content Filtered\n\n${reasonMessage}\n\nPlease try a different prompt.`);
                    } else if (candidate.finishReason !== 'STOP' && candidate.finishReason !== 'MAX_TOKENS') {
                        const reasonMessage = candidate.finishMessage || '';
                        throw new Error(`‚ö†Ô∏è Generation Stopped\n\nReason: ${candidate.finishReason}\n${reasonMessage ? reasonMessage + '\n' : ''}\nPlease try a different prompt.`);
                    }
                }
            }

            // Extract image from response
            let imageBase64Response = null;
            let responseText = null;

            if (data.candidates && data.candidates.length > 0) {
                const candidate = data.candidates[0];
                
                if (candidate.content && candidate.content.parts) {
                    const parts = candidate.content.parts;
                    
                    for (const part of parts) {
                        if (part.inlineData && part.inlineData.data) {
                            imageBase64Response = part.inlineData.data;
                            break;
                        }
                        if (part.inline_data && part.inline_data.data) {
                            imageBase64Response = part.inline_data.data;
                            break;
                        }
                        if (part.text) {
                            responseText = part.text;
                        }
                    }
                }
                else if (candidate.parts) {
                    for (const part of candidate.parts) {
                        if (part.inlineData && part.inlineData.data) {
                            imageBase64Response = part.inlineData.data;
                            break;
                        }
                        if (part.inline_data && part.inline_data.data) {
                            imageBase64Response = part.inline_data.data;
                            break;
                        }
                        if (part.text) {
                            responseText = part.text;
                        }
                    }
                }
            }
            else if (data.parts) {
                for (const part of data.parts) {
                    if (part.inlineData && part.inlineData.data) {
                        imageBase64Response = part.inlineData.data;
                        break;
                    }
                    if (part.inline_data && part.inline_data.data) {
                        imageBase64Response = part.inline_data.data;
                        break;
                    }
                    if (part.text) {
                        responseText = part.text;
                    }
                }
            }
            else if (data.error) {
                throw new Error(data.error.message || 'API returned an error');
            }
            else {
                console.error('Unexpected response format:', data);
                throw new Error(`Invalid response format from API. Response structure: ${JSON.stringify(Object.keys(data)).substring(0, 200)}`);
            }

            if (!imageBase64Response && responseText) {
                throw new Error(`API returned text instead of an image:\n\n${responseText.substring(0, 500)}`);
            }

            if (!imageBase64Response) {
                throw new Error('No image data in response. The API may not support image generation with your current plan, or the model may have returned an error. Check the browser console for details.');
            }

            return { imageBase64: imageBase64Response };
        }
    </script>
</body>
</html>




















